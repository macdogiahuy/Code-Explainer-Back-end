<UserControl x:Class="CodeExplainer.Desktop.Views.Notifications.NotificationsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:helpers="clr-namespace:CodeExplainer.Desktop.Helpers"
             mc:Ignorable="d">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <helpers:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock Text="Thông báo" FontWeight="SemiBold" FontSize="20" />
            <Button Content="Tải lại" 
                    Command="{Binding LoadNotificationsCommand}" 
                    IsEnabled="{Binding IsConnected}"
                    Margin="12,0,0,0" />
            <TextBlock Text="{Binding ConnectionStatus}" 
                      Foreground="{Binding IsConnected, Converter={StaticResource BoolToBrushConverter}}"
                      VerticalAlignment="Center"
                      Margin="12,0,0,0" />
        </StackPanel>

        <TextBlock Grid.Row="1" 
                  Text="{Binding Error}" 
                  Foreground="Red" 
                  TextWrapping="Wrap"
                  Margin="0,12,0,12"
                  Visibility="{Binding Error, Converter={StaticResource StringToVisibilityConverter}}" />

        <ScrollViewer Grid.Row="2" Margin="0,12,0,0">
            <StackPanel>
                <Button Content="Đánh dấu tất cả là đã đọc" 
                        Command="{Binding MarkAllAsReadCommand}"
                        IsEnabled="{Binding IsConnected}"
                        Visibility="{Binding UnreadCount, Converter={StaticResource IntToVisibilityConverter}}"
                        Margin="0,0,0,12" />
                        
                <ItemsControl ItemsSource="{Binding Notifications}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,0,0,12" 
                                    Padding="16" 
                                    Background="White" 
                                    BorderBrush="{StaticResource SurfaceBorderBrush}"
                                    BorderThickness="1" 
                                    CornerRadius="12">
                                <StackPanel>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                        <TextBlock Grid.Column="1" 
                                                 Text="{Binding CreatedAt, StringFormat=dd/MM/yyyy HH:mm}"
                                                 FontSize="12" 
                                                 Foreground="{StaticResource TextSecondaryBrush}" />
                                    </Grid>
                                    <TextBlock Text="{Binding Message}" TextWrapping="Wrap" Margin="0,8,0,0" />
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <Button Content="Đánh dấu đã đọc" 
                                                Command="{Binding DataContext.MarkAsReadCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}" 
                                                IsEnabled="{Binding DataContext.IsConnected, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                Visibility="{Binding IsRead, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                        <Button Content="Xóa" 
                                                Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}" 
                                                IsEnabled="{Binding DataContext.IsConnected, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                Margin="8,0,0,0" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <Control Grid.Row="0" Grid.RowSpan="3"
                Style="{StaticResource LoadingSpinnerStyle}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
    </Grid>
</UserControl>
